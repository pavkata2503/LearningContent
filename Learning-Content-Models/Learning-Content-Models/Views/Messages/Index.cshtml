@using Microsoft.AspNetCore.Html
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using Learning_Content_Models.Models;
@using Learning_Content_Models.Service;
@using Learning_Content_Models.Service.IService;
@using Microsoft.AspNetCore.Identity;
@using Microsoft.AspNetCore.Mvc;
@using System.Security.Claims;
@using Microsoft.DotNet.Scaffolding.Shared.Messaging
@using System.Text.RegularExpressions
@model IEnumerable<Learning_Content_Models.Models.Message>
@* @{
    string search = string.Empty;
    if (Model != null && Model.First().SearchQuery != null)
    {
        search = Model.First().SearchQuery;
    }

    // Function to highlight search keyword
    Func<string, IHtmlContent> HighlightSearchKeyword = (text) =>
    {
        if (!string.IsNullOrEmpty(search))
        {
            // Use regular expression to replace search keyword with highlighted span
            string pattern = $"({Regex.Escape(search)})";
            string highlightedText = Regex.Replace(text, pattern, "<span class='highlight'>$1</span>", RegexOptions.IgnoreCase);
            return new HtmlString(highlightedText);
        }
        return new HtmlString(text);
    };
} *@

<style>
    .highlight {
        color: black;
        font-weight: bold;
    }
</style>
@* @{
	string search = string.Empty;
	if(Model != null && Model.First().SearchQuery != null)
	{
		search = Model.First().SearchQuery;
	}
} *@

<link rel="stylesheet" href="/css/StudyMaterial.css" asp-append-version="true" />

@* <div>
	<form asp-action="Index" method="get">
		<div class="form-group">
			<input type="text" name="TextMessage" placeholder="Search by keyword" />
			<button type="submit">Search</button>
		</div>
	</form>
</div> *@
<input type="text" id="searchInput" placeholder="Search by title or genre..." />
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
	@foreach (var item in Model)
	{
		@if (User.Identity.Name == @item.Receiver || User.Identity.Name == item.SenderEmail || User.IsInRole("Admin"))
		{
			<div class="col search">
				<div class="card shadow-sm">
					<div class="card-body">

						<h3 class="text">@item.Text</h3>
						<p class="card-text">Изпратено от: @item.Sender</p>
						<p class="card-text">Изпратено за: @item.Receiver</p>
						<p>
							Status: @if (item.IsRead)
							{
								<text>Прочетено</text>
							}
							else
							{
								<text>Непрочетено</text>
							}
						</p>
						<!-- Add other fields as needed -->
						<div class="d-flex justify-content-between align-items-center">
							<div class="btn-group">
								<form asp-action="Delete" asp-route-id="@item.Id" method="post" onsubmit="return confirm('Are you sure you want to delete this Message?');">
									<button type="submit" class="btn btn-danger">Езтрии</button>
								</form>
								@if (!item.IsRead && User.Identity.Name == @item.Receiver)
								{
									<form asp-action="MarkAsRead" asp-route-id="@item.Id" method="post">
										<button type="submit" class="btn btn-sm btn-outline-secondary">Прочети</button>
									</form>
								}
								<p class="date">@item.SendDate.ToString("dd/MM/yyyy")</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		}
	}
	<script>
		function searchMovies() {
			var query = document.getElementById("searchInput").value.toLowerCase();
			var movies = document.getElementsByClassName("search");
			for (var i = 0; i < movies.length; i++) {
				var movie = movies[i];
				var titleElement = movie.getElementsByClassName("text")[0];

				var title = titleElement.innerText.toLowerCase();

				// Bold the searched word in the title
				var boldTitle = title.replace(new RegExp(query, 'ig'), '<b>$&</b>');
				titleElement.innerHTML = boldTitle;

				// Check for inclusion and set display property
				if (title.includes(query)) {
					movie.style.display = "table-row";
				} else {
					movie.style.display = "none";
				}
			}
		}

		var searchInput = document.getElementById("searchInput");
		searchInput.addEventListener("keyup", function () {
			searchMovies();
		});
	</script>
</div>
<a asp-action="Add" asp-controller="Messages" class="btn btn-success">
	Add New Message
</a>



